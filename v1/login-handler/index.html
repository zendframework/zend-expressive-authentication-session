<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Username/password, session-backed authentication adapter for zend-expressive-authentication.">  
    <link rel="canonical" href="https://docs.zendframework.com/zend-expressive-authentication-session/v1/login-handler/">
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Login Handlers - zend-expressive-authentication-session - Zend Framework Docs</title>

    <link rel="stylesheet" href="../../css/styles-5cfabd53ee.css">
</head>
<body id="page-top">

    
    <div class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">

            
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            
            <span class="navbar-brand">
                <a class="logo-link" href="https://framework.zend.com/" data-tooltip data-placement="bottom" title="Go to the ZF homepage">
                    <img src="../../img/zend-framework-logo.svg" height="28" alt="Zend Framework">
                </a>
            </span>
        </div>

        <div class="navbar-collapse collapse">

            
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://framework.zend.com/about">About</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/downloads">Install</a>
                </li>
                <li class="active">
                    <a href="https://docs.zendframework.com">Documentation</a>
                </li>
                <li>
                    <a href="https://www.zend.com/en/services/training">Training</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/blog">Blog</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/participate">Participate</a>
                </li>
            </ul>

            
            
                <div class="nav navbar-nav navbar-collapse visible-xs-block ">
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">zend-expressive-authentication-session</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                

                    
                    
                        
                            <li class="subnavigation__list-item ">
                                <a href="../intro/" class="subnavigation__link">Introduction</a>
                            </li>
                        
                    
                
            

                
                

                    
                    
                        
                            <li class="subnavigation__list-item">
                                <span class="subnavigation__headline">Tutorial</span>
                                <ul class="subnavigation__list">
                                    
                                        
    <li class="subnavigation__list-item ">
        <a href="../config/" class="subnavigation__link">Configuration</a>
    </li>

                                    
                                        
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Login Handlers</a>
    </li>

                                    
                                        
    <li class="subnavigation__list-item ">
        <a href="../requiring-authentication/" class="subnavigation__link">Handlers Requiring Authentication</a>
    </li>

                                    
                                </ul>
                            </li>
                        
                    
                
            
        </ul>
    </div>

                </div>
            

            
            <div class="nav navbar-nav navbar-collapse visible-xs-block">
                <div class="component-selector">
    <h4 class="component-selector__title">Components</h4>
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
            </div>
        </div>
    </div>
</div>

    
    <header class="header">
    <div class="container">
        <div class="row">

            
            <div class="col-xs-8">
                <h1 class="header__title">
                    Documentation

                    
                        <small class="header__subtitle">zend-expressive-authentication-session</small>
                    
                </h1>
            </div>

            
            <div class="col-xs-4 text-right">
                
                    

                    <a href="#" class="header__link header__link--search" data-toggle="modal" data-target="#mkdocs_search_modal" title="Open search">
                        <i class="fa fa-search"></i> Search
                    </a>
                    <a href="https://github.com/zendframework/zend-expressive-authentication-session/" class="header__link header__link--github" title="Go to repository of zend-expressive-authentication-session">
                        <i class="fa fa-github"></i> GitHub
                    </a>
                
            </div>
        </div>
    </div>
</header>

    
    <div class="laminas-announcement">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                Zend Framework transitions to the Linux Foundation. <a href="https://getlaminas.org">Learn More.</a>
            </div>
        </div>
    </div>
</div>

    
    <div class="container">
        <div class="row">
            <div class="col-md-9 col-xs-12 content" role="main">
            <!-- content:begin -->
                
                    <ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
    <li><a href="https://framework.zend.com/">Home</a></li>

    
        <li><a href="https://docs.zendframework.com/">Documentation</a></li>

        
            <li><a href="../..">zend-expressive-authentication-session</a></li>

            
                
                    
                    
                        <li>Tutorial</li>
                    
                
            

            <li class="active">Login Handlers</li>
        
    
</ol>






    
    
        <h2 class="chapter__headline">Tutorial</h2>
    

    <div>
        
    

    
    
        <div class="toc">
            <h6 class="toc__headline">In This Article</h6>
            <ul class="toc__list">
                
                    <li class="toc__entry">
                        <a href="#create-the-handler" class="toc__link">Create the handler</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#edit-the-template" class="toc__link">Edit the template</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#create-the-route" class="toc__link">Create the route</a>
                    </li>
                
            </ul>
        </div>
    

    </div>

    <h1 id="handling-an-initial-login">Handling an initial login</h1>
<p>When you have configured the adapter, you can drop in the
zend-expressive-authentication <code>AuthenticationMiddleware</code> anywhere you need to
ensure you have an authenticated user. However, how do you handle the initial
authentication?</p>
<p>In the <a href="../config/">previous chapter</a>, we indicated that you need to configure a
path to which to redirect when the adapter does not detect a user. In this
chapter, we'll detail how to create a login handler for processing user
credentials.</p>
<p>Roughly, what we need to do is:</p>
<ul>
<li>
<p>Create a handler that will both display and handle a login form, redirecting
  to the originally requested location once a successful authentication occurs.</p>
</li>
<li>
<p>Create a template with a form for capturing the username and password.</p>
</li>
<li>
<p>Create a route to the new handler.</p>
</li>
</ul>
<h2 id="create-the-handler">Create the handler</h2>
<p>We will use the <a href="https://docs.zendframework.com/zend-expressive/v3/reference/cli-tooling">zend-expressive CLI tooling</a>
to generate our handler, as well as the related factory and template:</p>
<p> <pre class=codehilite><code class=language-bash>$ ./vendor/bin/expressive handler:create &quot;App\Login\LoginHandler&quot;</code></pre></p>
<p>By default, if you have a configured template engine, this will do the
following:</p>
<ul>
<li>
<p>Create the handler for you.</p>
</li>
<li>
<p>Create logic in the handler to render a template and return the contents in
  a response.</p>
</li>
<li>
<p>Create a factory for the handler.</p>
</li>
<li>
<p>Create a template for you in an appropriate directory.</p>
</li>
</ul>
<p>When it does these things, it provides you with the paths to each as well. In
our case, we are using the <a href="https://docs.zendframework.com/zend-expressive/v3/features/template/plates/">PlatesPHP templating integration</a>,
with a flat application structure, and the following files were either created
or updated:</p>
<ul>
<li>
<p><code>src/App/Login/LoginHandler.php</code>, which contains the handler class itself.</p>
</li>
<li>
<p><code>src/App/Login/LoginHandlerFactory.php</code>, which contains the factory for the handler.</p>
</li>
<li>
<p><code>config/autoload/zend-expressive-tooling-factories.global.php</code>, which maps the
  handler to its factory for the DI container.</p>
</li>
<li>
<p><code>templates/app/login.phtml</code>, which contains our template.</p>
</li>
</ul>
<p>Now that we have created the handler, we can edit it to do the work we need.</p>
<p>Our handler will react to two different HTTP methods.</p>
<p>For an initial login request, the <code>GET</code> method will be used, and we will need to
display our template. When we do, we will also memoize the originally requested
URI (using the <code>Referer</code> request header).</p>
<p>When the user submits the form, it will be via the <code>POST</code> method. When this
happens, we will need to validate the submitted credentials; we will do this
using the <code>PhpSession</code> adapter from this package. If login is successful, we
will redirect to the originally requested URI, using the value we previously
stored in our session. If login fails, we will display our template, adding an
error message indicating the credentials were invalid.</p>
<p>The generated handler will already compose the <code>TemplateRendererInterface</code>, and
render a template. We will need to add a constructor dependency on the
<code>PhpSession</code> adapter, and store that value in a property. Additionally, since we
will be performing a redirect for successful POST requests, we will need to add
a requirement on <code>Zend\Diactoros\Response\RedirectResponse</code> in addition to the
logic changes in the handler.</p>
<p>The end result should look like this:</p>
<p> <pre class=codehilite><code class=language-php>namespace App\Login;

use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\RequestHandlerInterface;
use Zend\Diactoros\Response\HtmlResponse;
use Zend\Diactoros\Response\RedirectResponse;           // add this line
use Zend\Expressive\Authentication\Session\PhpSession;  // add this line
use Zend\Expressive\Session\SessionInterface;           // add this line
use Zend\Expressive\Authentication\UserInterface;       // add this line
use Zend\Expressive\Template\TemplateRendererInterface;


class LoginHandler implements RequestHandlerInterface
{
    private const REDIRECT_ATTRIBUTE = 'authentication:redirect';

    /** @var PhpSession */
    private $adapter;

    /** @var TemplateRendererInterface */
    private $renderer;

    public function __construct(TemplateRendererInterface $renderer, PhpSession $adapter)
    {
        $this-&gt;renderer = $renderer;
        $this-&gt;adapter = $adapter;
    }

    public function handle(ServerRequestInterface $request) : ResponseInterface
    {
        $session  = $request-&gt;getAttribute('session');
        $redirect = $this-&gt;getRedirect($request, $session);

        // Handle submitted credentials
        if ('POST' === $request-&gt;getMethod()) {
            return $this-&gt;handleLoginAttempt($request, $session, $redirect);
        }

        // Display initial login form
        $session-&gt;set(self::REDIRECT_ATTRIBUTE, $redirect);
        return new HtmlResponse($this-&gt;renderer-&gt;render(
            'app::login',
            []
        ));
    }

    private function getRedirect(
        ServerRequestInterface $request,
        SessionInterface $session
    ) : string {
        $redirect = $session-&gt;get(self::REDIRECT_ATTRIBUTE);

        if (! $redirect) {
            $redirect = $request-&gt;getHeaderLine('Referer');
            if (in_array($redirect, ['', '/login'], true)) {
                $redirect = '/';
            }
        }

        return $redirect;
    }

    private function handleLoginAttempt(
        ServerRequestInterface $request,
        SessionInterface $session,
        string $redirect
    ) : ResponseInterface {
        // User session takes precedence over user/pass POST in
        // the auth adapter so we remove the session prior
        // to auth attempt
        $session-&gt;unset(UserInterface::class);

        // Login was successful
        if ($this-&gt;adapter-&gt;authenticate($request)) {
            $session-&gt;unset(self::REDIRECT_ATTRIBUTE);
            return new RedirectResponse($redirect);
        }

        // Login failed
        return new HtmlResponse($this-&gt;renderer-&gt;render(
            'app::login',
            ['error' =&gt; 'Invalid credentials; please try again']
        ));
    }
}</code></pre></p>
<p>With these changes in place, our handler is now ready. However, we need to
update our factory, as we've added a new dependency!</p>
<p>To do this, run the following from the command line, in the project root
directory:</p>
<p> <pre class=codehilite><code class=language-bash>$ rm src/App/Login/LoginHandlerFactory.php
$ ./vendor/bin/expressive factory:create &quot;App\Login\LoginHandler&quot;</code></pre></p>
<p>This will regenerate the factory for you.</p>
<h2 id="edit-the-template">Edit the template</h2>
<p>We will now edit the template. The main considerations are:</p>
<ul>
<li>
<p>It needs to have a form that submits back to the login page.</p>
</li>
<li>
<p>The form needs both a <code>username</code> and a <code>password</code> field.</p>
</li>
<li>
<p>We need to display an error message if one was provided.</p>
</li>
</ul>
<p>Our application is built off the skeleton, and so we are currently using
<a href="https://getbootstrap.com">Bootstrap</a> for a UI framework. We are also using
PlatesPHP as noted earlier. As such, we will update the template in
<code>templates/app/login.phtml</code> to read as follows:</p>
<p> <pre class=codehilite><code class=language-php>&lt;div class=&quot;container&quot;&gt;
    &lt;div class=&quot;row&quot;&gt;
        &lt;div class=&quot;col-sm&quot;&gt;&lt;form action=&quot;&lt;?= $this-&gt;url('login') ?&gt;&quot; method=&quot;post&quot;&gt;
            &lt;?php if (isset($error)) : ?&gt;
            &lt;div class=&quot;alert alert-danger&quot; role=&quot;alert&quot;&gt;
                &lt;?= $this-&gt;escapeHtml($error) ?&gt;
            &lt;/div&gt;
            &lt;?php endif ?&gt;

            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;
                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;Enter username&quot;&gt;
            &lt;/div&gt;

            &lt;div class=&quot;form-group&quot;&gt;
                &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;
                &lt;input type=&quot;password&quot; class=&quot;form-control&quot; id=&quot;password&quot; name=&quot;password&quot; placeholder=&quot;Password&quot;&gt;
            &lt;/div&gt;

            &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Submit&lt;/button&gt;
        &lt;/form&gt;&lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre></p>
<blockquote>
<h3>Template location and structure</h3>
<p>Keep in mind the following when reading the above sample:</p>
<ul>
<li>
<p>If you are using the modular structure, the template may be in a different
  location. Use the output from the <code>expressive handler:create</code> command to
  determine the exact location.</p>
</li>
<li>
<p>If you are using a different template engine, the syntax of the template
  may vary.</p>
</li>
<li>
<p>The HTML may need to vary based on your own site's UI framework and CSS.</p>
</li>
</ul>
</blockquote>
<h2 id="create-the-route">Create the route</h2>
<p>Now that we have the handler and template created, we need to create a route for
the new handler that handles two HTTP methods: <code>GET</code> for displaying the initial
form, and <code>POST</code> for validating submitted credentials. Open up your
<code>config/routes.php</code> file, and edit it to add the following within its callback:</p>
<p> <pre class=codehilite><code class=language-php>$app-&gt;route(
    '/login',
    [
        Zend\Expressive\Session\SessionMiddleware::class,
        App\Login\LoginHandler::class,
    ],
    ['GET', 'POST'],
    'login'
);</code></pre></p>
<blockquote>
<h3>Understanding the routing</h3>
<p>You may not be familiar with the <code>route()</code> method, or middleware pipelines. If
the above doesn't make sense, keep reading for an explanation.</p>
<p>First, we are using the <code>route()</code> method, as we want to create a <em>single</em> route
to respond to <em>multiple</em> HTTP methods. This method has a required third argument,
which is an array of HTTP methods; we specify <code>GET</code> and <code>POST</code> in this array.</p>
<p>Second, we are indicating that we want the route to respond to the exact path
<code>/login</code>; we provide this via the initial method argument.</p>
<p>Third, we are providing a name for this route via the optional fourth argument;
this is what allows us to call <code>$this-&gt;url('login')</code> in our template in order to
generate the URL to the login page.</p>
<p>Finally, for the middleware argument, we are providing a <a href="https://docs.zendframework.com/zend-expressive/v1/getting-started/features/#pipelines">pipeline</a>,
by providing an <em>array</em> of middleware to execute. The first item in the pipeline
is the <code>SessionMiddleware</code> from zend-expressive-session; this is required to
ensure we have a session container injected into the request. The second item is
our login handler itself, which will then do the actual work of creating a
response.</p>
</blockquote>
<p>With this route in place, any routes we write that require authentication will
now:</p>
<ul>
<li>
<p>Redirect to the <code>/login</code> page, which will require that:</p>
</li>
<li>
<p>A user provides credentials and submits the form back to the <code>/login</code> page,
  which will:</p>
</li>
<li>
<p>Process the credentials via the <code>PhpSession</code> adapter, which will store
  identified user details in the session, and:</p>
</li>
<li>
<p>Ultimately give them access (assuming any roles associated with them are
  authorized), and:</p>
</li>
<li>
<p>Redirect them back to the originally requested page.</p>
</li>
</ul>
<p>In the next chapter, we will <a href="../requiring-authentication/">detail how to require authentication for
individual handlers</a>.</p>




    <nav>
    <ul class="page-nav hidden-print">

        
        <li class="page-nav__item">
            
                <a rel="prev" class="page-nav__link page-nav__link--prev" href="../config/">
                    <i class="fa fa-chevron-left"></i> Previous
                </a>
            
        </li>

        
        <li class="page-nav__item">
            
                <a rel="next" class="page-nav__link page-nav__link--next" href="../requiring-authentication/">
                    Next <i class="fa fa-chevron-right"></i>
                </a>
            
        </li>
    </ul>
</nav>




    <div class="help-wanted">
        <p>
            Found a mistake or want to contribute to the documentation?
            <a href="https://github.com/zendframework/zend-expressive-authentication-session/edit/master/docs/book/v1/login-handler.md" target="_blank" class="help-wanted__link">
                Edit this page on GitHub!
            </a>
        </p>
    </div>

                
            <!-- content:end -->
            </div>
            <div class="col-md-3 col-xs-12 sidebar">
                
                    <div class="component-selector">
    <h4 class="component-selector__title">Components</h4>
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">zend-expressive-authentication-session</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                

                    
                    
                        
                            <li class="subnavigation__list-item ">
                                <a href="../intro/" class="subnavigation__link">Introduction</a>
                            </li>
                        
                    
                
            

                
                

                    
                    
                        
                            <li class="subnavigation__list-item">
                                <span class="subnavigation__headline">Tutorial</span>
                                <ul class="subnavigation__list">
                                    
                                        
    <li class="subnavigation__list-item ">
        <a href="../config/" class="subnavigation__link">Configuration</a>
    </li>

                                    
                                        
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Login Handlers</a>
    </li>

                                    
                                        
    <li class="subnavigation__list-item ">
        <a href="../requiring-authentication/" class="subnavigation__link">Handlers Requiring Authentication</a>
    </li>

                                    
                                </ul>
                            </li>
                        
                    
                
            
        </ul>
    </div>

                
            </div>
        </div>
    </div>

    
    <footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h5>Zend Framework</h5>
                <ul>
                    <li><a href="https://framework.zend.com/">framework.zend.com</a></li>
                    <li><a href="https://docs.zendframework.com">docs.zendframework.com</a></li>
                    <li><a href="https://packages.zendframework.com">packages.zendframework.com</a></li>
                    <li><a href="https://apigility.org">apigility.org</a></li>
                    <li><a href="https://getexpressive.org/">getexpressive.org</a></li>
                </ul>
            </div>
        </div>

        
        <div class="row">
            <div class="col-md-12 text-center">
                <a class="footer__button" href="#page-top"><i class="fa fa-chevron-up" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="row">

            
            <div class="col-md-9">
                <h4 class="footer__headline">Copyright</h4>
                <p>&copy; 2006-2019 by <a href="https://www.zend.com/">Zend</a>, a <a href="https://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            
            <div class="col-md-3">
                <h4 class="footer__headline">Support</h4>
                <ul class="support__list">
                    <li class="support__list-item">
                        <a href="https://discourse.zendframework.com" class="support__link" title="Forum"><i class="fa fa-comments"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://zendframework-slack.herokuapp.com" class="support__link" title="Chat"><i class="fa fa-slack"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://github.com/zendframework" class="support__link" title="Github"><i class="fa fa-github"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://twitter.com/zfdevteam" class="support__link" title="Twitter"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://tinyletter.com/mwopzend" class="support__link" title="Newsletter"><i class="fa fa-envelope"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://framework.zend.com/blog/feed-rss.xml" class="support__link" title="Blog feed"><i class="fa fa-rss"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://framework.zend.com/security/feed" class="support__link" title="Security feed"><i class="fa fa-rss-square"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script>
        var base_url = '../..',
            siteName = 'zend-expressive-authentication-session';
    </script>
    <script src="../../js/scripts-8d7ae56abf.js"></script>
        <script src="../../search/main.js"></script>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>



</body>


</html>
